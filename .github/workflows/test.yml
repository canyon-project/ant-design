name: âœ… test coverage

on:
  push:
    branches: [master, feature]
  pull_request:
    branches: [master, feature]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  test-react-latest:
    name: test-react-latest
    strategy:
      matrix:
        module: [dom]
        shard: [1/2, 2/2]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: utooland/setup-utoo@v1
      - run: ut

      - name: dom test
        run: ut test -- --maxWorkers=2 --shard=${{matrix.shard}} --coverage

      - name: persist coverages
        run: |
          mkdir persist-coverage
          mv coverage/coverage-final.json persist-coverage/react-test-${{matrix.module}}-${{strategy.job-index}}.json

      - uses: actions/upload-artifact@v4
        name: upload coverages
        with:
          name: coverage-artifacts-${{ matrix.module }}-${{ strategy.job-index }}
          path: persist-coverage/

  upload-test-coverage:
    name: test-coverage
    runs-on: ubuntu-latest
    needs: test-react-latest
    steps:
      - uses: actions/checkout@v6
      - uses: utooland/setup-utoo@v1
      - run: ut

      - uses: actions/download-artifact@v6
        with:
          pattern: coverage-artifacts-*
          merge-multiple: true
          path: persist-coverage
      - name: Merge Code Coverage
        run: |
          utx nyc merge persist-coverage/ coverage/coverage-final.json
          utx nyc report --reporter text -t coverage --report-dir coverage
          rm -rf persist-coverage

      - name: Install Canyon CLI
        run: npm i -g @canyonjs/cli

      - name: Canyon help
        run: canyon -h

      - name: Upload E2E coverage to Canyon
        env:
          CANYON_DSN: https://app.canyonjs.io/coverage/client
        run: >
          utx nyc merge persist-coverage/ .canyon_output/coverage-final.json
          canyon upload
          --dsn=$CANYON_DSN
          --repo_id=${{ github.repository_id }}
          --instrument_cwd=${{ github.workspace }}
          --sha=${{ github.sha }}
          --branch=${{ github.ref_name }}
          --provider=gitlab
          --debug=true
