name: ✅ test coverage

on:
  push:
    branches: [master, feature]
  pull_request:
    branches: [master, feature]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  test-react-latest:
    name: test-react-latest
    strategy:
      matrix:
        module: [dom]
        shard: [1/2, 2/2]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: utooland/setup-utoo@v1
      - run: ut

      - name: dom test
        run: ut test -- --maxWorkers=2 --shard=${{matrix.shard}} --coverage

      - name: persist coverages
        run: |
          mkdir persist-coverage
          mv coverage/coverage-final.json persist-coverage/react-test-${{matrix.module}}-${{strategy.job-index}}.json

      - uses: actions/upload-artifact@v4
        name: upload coverages
        with:
          name: coverage-artifacts-${{ matrix.module }}-${{ strategy.job-index }}
          path: persist-coverage/

  upload-test-coverage:
    name: test-coverage
    runs-on: ubuntu-latest
    needs: test-react-latest
    steps:
      - uses: actions/checkout@v6
      - uses: utooland/setup-utoo@v1
      - run: ut

      - uses: actions/download-artifact@v6
        with:
          pattern: coverage-artifacts-*
          merge-multiple: true
          path: persist-coverage

      - name: Merge Code Coverage
        run: |
          # 创建 coverage 目录（避免 nyc report 报错）
          mkdir -p coverage
          # 合并覆盖率文件到 coverage/coverage-final.json
          utx nyc merge persist-coverage/ coverage/coverage-final.json
          # 生成文本报告（可选，用于日志查看）
          utx nyc report --reporter text -t coverage --report-dir coverage
          # 保留 persist-coverage 目录（或直接用合并后的 coverage/coverage-final.json 上传）
          # 注意：不再删除 persist-coverage，或直接用合并后的文件路径

      - name: Install Canyon CLI
        run: npm i -g @canyonjs/cli

      - name: Canyon help
        run: canyon -h

      - name: Upload E2E coverage to Canyon
        env:
          CANYON_DSN: https://app.canyonjs.io/coverage/client
        run: |
          # 1. 确保 .canyon_output 目录存在（避免 canyon 上传时目录不存在）
          mkdir -p .canyon_output
          # 2. （可选）如果 canyon 需要读取 .canyon_output/coverage-final.json，重新合并一次（或直接复制已合并的文件）
          cp coverage/coverage-final.json .canyon_output/coverage-final.json
          # 3. 单独执行 canyon upload（关键：拆分命令，避免参数混在一起）
          canyon upload \
            --dsn=$CANYON_DSN \
            --repo_id=${{ github.repository_id }} \
            --instrument_cwd=${{ github.workspace }} \
            --sha=${{ github.sha }} \
            --branch=${{ github.ref_name }} \
            --provider=github \  # 修正：GitHub Actions 环境用 github，不是 gitlab
            --debug=true
